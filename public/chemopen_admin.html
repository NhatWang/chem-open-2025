<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω ƒëƒÉng k√Ω thi ƒë·∫•u</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    .pending {
      color: orange;
      font-weight: bold;
    }
    .paid {
      color: green;
      font-weight: bold;
    }
    .failed {
  color: red;
  font-weight: bold;
    }
    .action-buttons {
  display: flex;
  flex-direction: column;
  gap: 6px;
  align-items: center;
}
  button.mark-paid {
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
    width: 100%;
    white-space: nowrap;
  }

  button.mark-failed {
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
    width: 100%;
  }

  button.mark-paid:hover {
    background-color: #218838;
  }

  button.mark-failed:hover {
    background-color: #c82333;
  }
  @keyframes fadein {
  from { opacity: 0; right: 0px }
  to   { opacity: 1; right: 20px }
}
@keyframes fadeout {
  from { opacity: 1; right: 20px }
  to   { opacity: 0; right: 0px }
}
#partnerTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 30px;
  background: #fff;
}
#partnerTable th, #partnerTable td {
  padding: 10px;
  border: 1px solid #ccc;
  text-align: center;
}
#partnerTable th {
  background-color: #28a745;
  color: white;
}
  </style>
</head>
<body>
  <h1>Trang Qu·∫£n L√Ω Th√≠ Sinh ƒêƒÉng K√Ω</h1>
  <table id="dataTable">
    <thead>
      <tr>
        <th>STT</th>
        <th>MSSV</th>
        <th>H·ªç t√™n</th>
        <th>Email</th>
        <th>SƒêT</th>
        <th>Khoa</th>
        <th>L·ªõp</th>
        <th>N·ªôi dung thi ƒë·∫•u</th>
        <th>Ph∆∞∆°ng th·ª©c thanh to√°n</th>
        <th>Tr·∫°ng th√°i thanh to√°n</th>
        <th>Thao t√°c</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <h2>Th√¥ng Tin Ng∆∞·ªùi ƒê·∫•u C√πng</h2>
<table id="partnerTable">
  <thead>
    <tr>
      <th>STT</th>
      <th>MSSV Ng∆∞·ªùi ƒêƒÉng K√Ω</th>
      <th>H·ªç t√™n ng∆∞·ªùi ƒëƒÉng k√≠</th>
      <th>MSSV Ng∆∞·ªùi ƒê·∫•u C√πng</th>
      <th>H·ªç t√™n ng∆∞·ªùi ƒë·∫•u c√πng</th>
      <th>Email</th>
      <th>SƒêT</th>
      <th>Khoa</th>
      <th>L·ªõp</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
  <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const socket = io();
    
      socket.on("payment-updated", ({ mssv, status }) => {
        const rows = document.querySelectorAll("#dataTable tbody tr");
        rows.forEach(row => {
          if (row.children[1].textContent === mssv) {
            const statusCell = row.querySelector(".status");
            const actions = row.querySelector(".action-buttons");
            if (status === "paid") {
              statusCell.textContent = "‚úÖ ƒê√£ thanh to√°n";
              statusCell.className = "status paid";
              actions?.remove();
              showToast(`üéâ MSSV ${mssv} ƒë√£ thanh to√°n`, "success");
              showFinalThankYouModal();
            } else if (status === "failed") {
              statusCell.textContent = "‚ùå Th·∫•t b·∫°i";
              statusCell.className = "status failed";
              showToast(`‚ùå MSSV ${mssv} ƒë√£ th·∫•t b·∫°i`, "error");
            }
          }
        });
      });
    
      document.addEventListener("DOMContentLoaded", () => {
        const table = document.getElementById("dataTable");
    
        function loadTableData() {
          const tbody = document.querySelector("tbody");
          fetch("/api/registrations")
            .then(res => res.json())
            .then(data => {
              tbody.innerHTML = "";
              data.forEach((reg, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td>${index + 1}</td>
                  <td>${reg.mssv}</td>
                  <td>${reg.fullName}</td>
                  <td>${reg.email}</td>
                  <td>${reg.phone}</td>
                  <td>${reg.khoa}</td>
                  <td>${reg.lop}</td>
                  <td>${reg.noidung?.join(" + ") || "-"}</td>
                  <td>${reg.paymentMethod === "paypal" ? "PayPal" : "Chuy·ªÉn kho·∫£n"}</td>
                  <td class="status ${reg.paymentStatus}">
                    ${reg.paymentStatus === "paid"
                      ? "‚úÖ ƒê√£ thanh to√°n"
                      : reg.paymentStatus === "failed"
                      ? "‚ùå Th·∫•t b·∫°i"
                      : "‚ùå Ch∆∞a thanh to√°n"}
                  </td>
                  <td>
                    ${reg.paymentMethod === "bank" && reg.paymentStatus === "pending" ? `
                      <div class="action-buttons">
                        <button class="mark-paid" data-id="${reg.mssv}">Chuy·ªÉn kho·∫£n th√†nh c√¥ng</button>
                        <button class="mark-failed" data-id="${reg.mssv}">Chuy·ªÉn kho·∫£n th·∫•t b·∫°i</button>
                      </div>` : reg.paymentMethod === "paypal" && reg.paymentStatus === "pending" ? `
                      <span class="pending">ƒêang ch·ªù PayPal x·ª≠ l√Ω</span>` : ``}
                    <div style="margin-top: 6px;">
                      <button class="delete-entry" data-id="${reg.mssv}" style="background-color: #6c757d;">Xo√° ƒë∆°n</button>
                    </div>
                  </td>
                `;
                tbody.appendChild(row);
              });
    
              const partnerTbody = document.querySelector("#partnerTable tbody");
              partnerTbody.innerHTML = "";
              let partnerIndex = 1;
              data.forEach((reg) => {
                if (reg.partnerInfo && reg.partnerInfo.fullName) {
                  const row = document.createElement("tr");
                  row.innerHTML = `
                    <td>${partnerIndex++}</td>
                    <td>${reg.mssv}</td>
                    <td>${reg.fullName}</td>
                    <td>${reg.partnerInfo.mssv || "-"}</td>
                    <td>${reg.partnerInfo.fullName}</td>
                    <td>${reg.partnerInfo.email}</td>
                    <td>${reg.partnerInfo.phone}</td>
                    <td>${reg.partnerInfo.khoa}</td>
                    <td>${reg.partnerInfo.lop}</td>
                  `;
                  partnerTbody.appendChild(row);
                }
              });
            });
        }
    
        // ‚ö° G·ªåI KHI V·ª™A V√ÄO TRANG
        loadTableData();
    
        // üßæ Click thao t√°c c·∫≠p nh·∫≠t & xo√°
        document.addEventListener("click", (e) => {
          const isPaid = e.target.classList.contains("mark-paid");
          const isFailed = e.target.classList.contains("mark-failed");
          const isDelete = e.target.classList.contains("delete-entry");
    
          if (isPaid || isFailed) {
            const mssv = e.target.getAttribute("data-id");
            const newStatus = isPaid ? "paid" : "failed";
            const confirmText = isPaid
              ? `X√°c nh·∫≠n CHUY·ªÇN KHO·∫¢N TH√ÄNH C√îNG cho MSSV: ${mssv}?`
              : `X√°c nh·∫≠n CHUY·ªÇN KHO·∫¢N TH·∫§T B·∫†I cho MSSV: ${mssv}?`;
    
            if (!confirm(confirmText)) return;
    
            fetch("/api/update-payment", {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ mssv, paymentStatus: newStatus })
            })
              .then((res) => res.json())
              .then(() => {
                showToast("‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i!", "success");
                setTimeout(() => location.reload(), 1500);
              })
              .catch((err) => {
                console.error("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i:", err);
                showToast("‚ùå C√≥ l·ªói x·∫£y ra!", "error");
              });
          }
    
          if (isDelete) {
            const mssv = e.target.getAttribute("data-id");
            if (!confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° ƒë∆°n ƒëƒÉng k√Ω c·ªßa MSSV: ${mssv}?`)) return;
    
            fetch(`/api/delete-registration?mssv=${encodeURIComponent(mssv)}`, {
              method: "DELETE"
            })
              .then((res) => res.json())
              .then((data) => {
                if (data.success) {
                  showToast("üóëÔ∏è ƒê√£ xo√° ƒë∆°n ƒëƒÉng k√Ω!", "success");
                  setTimeout(() => location.reload(), 1000);
                } else {
                  showToast("‚ùå Kh√¥ng xo√° ƒë∆∞·ª£c ƒë∆°n.", "error");
                }
              })
              .catch((err) => {
                console.error("‚ùå L·ªói xo√° ƒë∆°n:", err);
                showToast("‚ùå C√≥ l·ªói x·∫£y ra!", "error");
              });
          }
        });
      });
    
      function showToast(message, type = "success") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.style.cssText = `
          background-color: ${type === "error" ? "#dc3545" : "#28a745"};
          color: white;
          padding: 12px 18px;
          margin-bottom: 10px;
          border-radius: 6px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.2);
          animation: fadein 0.5s, fadeout 0.5s 2.5s;
        `;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
    </script>
</body>
</html>
